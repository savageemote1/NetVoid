name: Deploy NetVoid Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_secure.txt
        
    - name: Run tests
      run: |
        python -c "import sys; print('Python version:', sys.version)"
        python -c "import flask; print('Flask version:', flask.__version__)"
        python -c "import Crypto; print('PyCrypto version:', Crypto.__version__)"
        
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_secure.txt
        
    - name: Create deployment package
      run: |
        mkdir -p deployment
        cp -r server deployment/
        cp -r client deployment/
        cp -r config deployment/
        cp -r templates deployment/
        cp -r static deployment/
        cp secure_web_server.py deployment/
        cp requirements_secure.txt deployment/
        cp install.py deployment/
        cp *.bat deployment/
        
        # Create deployment info
        echo "Deployment created at $(date)" > deployment/deployment_info.txt
        echo "Commit: ${{ github.sha }}" >> deployment/deployment_info.txt
        echo "Branch: ${{ github.ref_name }}" >> deployment/deployment_info.txt
        
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v3
      with:
        name: netvoid-deployment
        path: deployment/
        
    - name: Deploy notification
      run: |
        echo "ðŸš€ NetVoid Server deployment ready!"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Deployment package created successfully"
